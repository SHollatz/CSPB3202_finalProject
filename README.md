# CSPB3202_finalProject

3202 Introduction to AI - Final Project - Spring 2022
Analyzing Feature Extraction in Diffraction Image Classifiers
Author: Sabine Hollatz

Videopresentation:

Motivation and Background Information
This project is part of my internship at the National Accelerator Laboratory SLAC with the Molecular Crystallography group. Crystallography is an important method for determining biological structures, based on which drugs for diseases can be developed. For example, the Zika virus shell could be determined by this research field. Currently, research on coronavirus 2 (SARS-CoV-2) is conducted.

Crystallography research analyzes and determines the molecular structure of macromolecules, such as proteins, in crystallized form. During an X-ray diffraction experiment, the X-ray beam can interact with the electrons of a protein crystal and diffract in a structure-specific pattern. These diffraction patterns are recorded by an area detector in form of diffraction images. Crystallographic experiments have led to substantial advances including structure-based drug development fo fighting diseases.

Artificial Intelligence can support this important field of research by providing automatic means to gauge experimental success in real-time. Especially serial crystallography is challenging, where hundreds of thousands of tiny crystals are exposed to X-rays in random orientations and lost after beam impact. Often only one diffraction image is detected from each crystal. The analyses of large serial diffraction datasets currently take from hours to days. Detector improvemens have further increased the amount of data to massive amounts of data (~25 Gbit/s). Machine learning models will be applied to detect and discard blank images while ensuring that images with usable diffraction are not lost. Furthermore, they will detect problematic diffraction images (such as images with split diffraction spots) that cannot be identified and analyzed by the currently available crystallographic software. Overall, Machine learning models will dramatically reduce the time, storage and effort required to aptly process challenging datasets.

My Previous Work in the Internship Project
First, initial machine learning tests with simulated 512x512 8-bit images of crystal diffraction (photosystem II) were promising. Categories were: blank, no-crystal, and weak, good, and strong diffraction. I could train a classifier that predicted diffraction quality with an accuracy of more than 90% and that generalized well in tests with completely new data. Second, I conducted further ML tests by adding more complex categories to the data. These categories included partial ice rings and mixing patterns from two different types of protein (photosystem I and photosystem II), as well as smeared diffraction spots caused by flawed crystals. The simulated training images were categorized into 6 different categories in total: blank/no diffraction, photosystem I, photosystem II, multilattice (smeared spots), ice diffraction, and dangerous ice diffraction, which can damage the detector. In addition, two continuous parameters for the mosaicity of the flawed crystals were predicted. The goal was to train a single model that can fulfill both tasks at once, categorization and regression, trained on the same dataset. Multitask learning models supposedly perform better than separately trained models. However, the second part of the project turned out to be challenging. The multitask learning approach did not learn from scratch, but needed initial weights that were suited to diffraction images. When I applied transfer learning based on the simple classifier from the first part of the project, I finally saw learning behavior. But the performance of the regression compound was still far off and, even though it was better, the performance of the classifier compound was also disappointing. For that reason, I reduced the multitask learning approach to multilabel classification without regression. The achieved accuracies were partially fine, partially disappointing, and partially not even better than random (blank: 92.25%, photo1: 51.96%, photo2: 57.16%, multilattice: 76.56%, ice: 22.64%, badice: 13.71%). To ensure that ice patterns and smeared spots can be detected by a classifier in general, I trained two binary classifiers, one for each task. Ice could be detected with an accuracy of 89.7% on test data and smeared spots with an accuracy of 66.91%.

The Current Project in CSPB 3202
Recent discussions within our team braught up the question, if the pixel patterns for each category are significant enough in the training data to enable machine learning models to pick up on them. This is particularly interesting, because the training images are downsampled so that the computational expense for training convolutional neural networks (CNNs) is kept feasible. CNNs are known for being opaque during their feature extraction process on which they make their predictions and are often referred to as black boxes. Nevertheless, I will attempt to extract, display and analyze convolutional filters and feature maps from the previously trained classifiers and try to gain more insight on the learned representations. These results may influence future training approaches and architecture designs in general, and, in particular, the decision if we continue training with downsampled images or switch to cropped pieces of images.

The Data
Experimental diffraction images are poorly suited to ML training, as they are easy to mis-categorize by eye and difficult to obtain in sufficient quantity for each category. Therefore, the training dataset is simulated. The physics of X-ray diffraction are well understood and a simulator was developed by my mentor, James Holton. Input to the simulation software includes specific X-ray properties and the experimental environment. More information about the simulator can be found here: http://bl831.als.lbl.gov/~jamesh/nanoBragg The dataset used to train the previously described models consists of 41956 diffraction images (8 bit grayscale images of size 512x512) in png and pgm format that are distributed over 6 categories: blank, photo1, photoII, multilattice, ice and badice. Each image can belong to more than one category, but does not have to. In addition, two numeric mosaicitiy parameters are provided, continuous numbers between 0 and 1, that stand for the level of which a crystal is split into sub-crystals. Split crystals cause smeared or split spots that are difficult to process by current crystallographic software.
